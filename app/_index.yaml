version: "1.0"
namespace: app

entries:
  ###########################
  #   Dependency entries    #
  ###########################

  - name: __dependency.wippy.actor
    kind: "ns.dependency"
    meta:
      description: "Actor component"
    component: "wippy/actor"
    version: ">=v0.0.8"

  # Temporarily disabled due to token_refresh.service host configuration issue
  # - name: __dependency.wippy.llm
  #   kind: "ns.dependency"
  #   meta:
  #     description: "LLM component"
  #   component: "wippy/llm"
  #   version: ">=v0.0.7"
  #   parameters:
  #     - name: "application_host"
  #       value: "app:processes"

  # - name: __dependency.wippy.test
  #   kind: "ns.dependency"
  #   meta:
  #     description: "Testing component"
  #   component: "wippy/test"
  #   version: ">=v0.0.7"

  # Requirements demo dependencies
  - name: API_ROUTER
    kind: ns.definition
    targets:
      - entry: hello_world_dependency
        path: .parameters[] | select(.name == "api_router") | .value

  - name: hello_world_dependency
    kind: "ns.dependency"
    meta:
      description: "Requirements demo dependency"
    component: "igor-test-3/test-2"
    version: ">=v0.0.1"
    parameters:
      - name: api_router
        value: "app:api"

  # LLM token refresh service override (disabled)
  # - name: token_refresh.service
  #   namespace: wippy.llm.google.vertex
  #   kind: process.service
  #   meta:
  #     comment: "Token Refresh Service (disabled override)"
  #     provider: "vertex"
  #   host: app:processes
  #   process: dummy_process  # Dummy process reference
  #   lifecycle:
  #     auto_start: false  # Disable auto-start to avoid issues
  # 
  # # Dummy process for token_refresh.service override
  # - name: dummy_process
  #   namespace: wippy.llm.google.vertex
  #   kind: process.lua
  #   meta:
  #     comment: "Dummy process for token refresh service override"
  #   source: file://dummy.lua
  #   method: run
  #   modules: [ time ]

  ###########################
  #   Local components      #
  ###########################

  - name: bapp
    kind: library.lua
    meta:
      comment: "Bubble Tea app wrapper library"
    source: file://bapp.lua
    modules: [ btea, channel, upstream ]

  ###########################
  #   Application entries   #
  ###########################

  # app:gateway
  - name: gateway
    kind: http.service
    meta:
      comment: "Main HTTP gateway service"
    addr: ":8082"
    timeouts:
      idle: 60s
      read: 30s
      write: 30s
    lifecycle:
      auto_start: true
      restart:
        initial_delay: 5s
        max_attempts: 3
        backoff_factor: 1.5

  # app:api
  - name: api
    kind: http.router
    meta:
      comment: "API router for v1 endpoints"
      server: gateway
      depends_on:
        - gateway
    prefix: /api/v1
    timeouts:
      request: 30s

  # app:terminal
  - name: terminal
    kind: terminal.host
    meta:
      comment: "System terminal host"
    hide_logs: false
    lifecycle:
      auto_start: true
      restart:
        initial_delay: 5s
        max_attempts: 3
        backoff_factor: 1.5

  # app:processes
  - name: processes
    kind: process.host
    meta:
      comment: "Process execution host"
    host:
      workers: 32
      max_processes: 20000
    lifecycle:
      auto_start: true
      restart:
        initial_delay: 5s
        max_attempts: 3
        backoff_factor: 1.5

  # app:heap (temporarily disabled due to timeout issues)
  # - name: heap
  #   kind: memstore.store
  #   meta:
  #     comment: "In-memory data store"
  #   lifecycle:
  #     auto_start: true

