version: "1.0"
namespace: app

meta:
  depends_on: [ ns:system ]
  comment: "Application namespace configuration"

entries:
  # app:processes
  - name: processes
    kind: process.host
    meta:
      comment: "Process execution host"
    host:
      workers: 32
      max_processes: 20000
    lifecycle:
      auto_start: true
      restart:
        initial_delay: 5s
        max_attempts: 3
        backoff_factor: 1.5

  # app:api
  - name: api
    kind: http.router
    meta:
      comment: "API router for v1 endpoints"
      server: gateway
      depends_on:
        - gateway
    prefix: /api/v1
    timeouts:
      request: 30s

  - name: gateway
    kind: http.service
    meta:
      comment: "Main HTTP gateway service"
    addr: ":8082"
    timeouts:
      idle: 60s
      read: 30s
      write: 30s
    lifecycle:
      auto_start: true
      restart:
        initial_delay: 5s
        max_attempts: 3
        backoff_factor: 1.5

  - name: envfile
    kind: env.storagefile
    meta:
      type: envstorage
      comment: Memory storage for environment variables
    file_path: "./.env"

  - name: VERTEX_AI_PRIVATE_KEY_ID
    kind: env.variable
    meta:
      type: secret_key
      depends_on:
        - app:envfile
    variable: VERTEX_AI_PRIVATE_KEY_ID
    storage: app:envfile
    default:

  - name: VERTEX_AI_CLIENT_EMAIL
    kind: env.variable
    meta:
      type: secret_key
      depends_on:
        - app:envfile
    variable: VERTEX_AI_CLIENT_EMAIL
    storage: app:envfile
    default:

  - name: VERTEX_AI_PRIVATE_KEY
    kind: env.variable
    meta:
      type: secret_key
      depends_on:
        - app:envfile
    variable: VERTEX_AI_PRIVATE_KEY
    storage: app:envfile
    default:

  - name: VERTEX_AI_PROJECT
    kind: env.variable
    meta:
      type: secret_key
      depends_on:
        - app:envfile
    variable: VERTEX_AI_PROJECT
    storage: app:envfile
    default:

  - name: VERTEX_AI_LOCATION
    kind: env.variable
    meta:
      type: secret_key
      depends_on:
        - app:envfile
    variable: VERTEX_AI_LOCATION
    storage: app:envfile
    default:

  - name: ANTHROPIC_API_KEY
    kind: env.variable
    meta:
      type: secret_key
      depends_on:
        - app:envfile
    variable: ANTHROPIC_API_KEY
    storage: app:envfile
    default:

  - name: OPENAI_API_KEY
    kind: env.variable
    meta:
      type: secret_key
      depends_on:
        - app:envfile
    variable: OPENAI_API_KEY
    storage: app:envfile
    default:

  - name: bapp
    kind: library.lua
    meta:
      comment: "Bubble Tea app wrapper library"
    source: file://bapp.lua
    modules: [ btea, channel, upstream ]

  # app:terminal
  - name: terminal
    kind: terminal.host
    meta:
      comment: "System terminal host"
    hide_logs: false
    lifecycle:
      auto_start: true
      restart:
        initial_delay: 5s
        max_attempts: 3
        backoff_factor: 1.5

  - name: cache
    kind: store.memory
    meta:
      comment: "Application cache storage"
    max_size: 10000
    cleanup_interval: 30m
    lifecycle:
      auto_start: true
